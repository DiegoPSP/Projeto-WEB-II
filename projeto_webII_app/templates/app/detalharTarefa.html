{% extends 'app/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow-sm border-secondary">
            <div class="card-body p-4 p-md-5">

                {% if tarefa.imagem %}
                    <img src="{{ tarefa.imagem.url }}" alt="Imagem da Tarefa: {{ tarefa.titulo }}" class="img-fluid rounded mb-4 shadow-lg" style="width: 100%; max-height: 400px; object-fit: cover;">
                {% endif %}

                <h1 class="display-5 mb-3">{{ tarefa.titulo }}</h1>

                <ul class="list-group list-group-flush list-group-horizontal-md mb-4 text-center text-md-start">
                    <li class="list-group-item bg-transparent text-white-50 border-bottom-0 border-secondary px-0 px-md-3">
                        <i class="bi bi-calendar-event text-success"></i> 
                        <strong>Data Limite:</strong><br> {{ tarefa.data_limite|date:"d/m/Y, \à\s H:i" }}
                    </li>
                    <li class="list-group-item bg-transparent text-white-50 border-bottom-0 border-secondary px-0 px-md-3">
                        <i class="bi bi-info-circle text-success"></i> 
                        <strong>Status:</strong><br> {{ tarefa.get_status_display }}
                    </li>
                    {% if tarefa.projeto %}
                    <li class="list-group-item bg-transparent text-white-50 border-bottom-0 border-secondary px-0 px-md-3">
                        <i class="bi bi-folder text-success"></i> 
                        <strong>Projeto:</strong><br> {{ tarefa.projeto.nome }}
                    </li>
                    {% endif %}
                    {% if tarefa.categoria %}
                    <li class="list-group-item bg-transparent text-white-50 border-bottom-0 border-secondary px-0 px-md-3">
                        <i class="bi bi-tag-fill text-success"></i> 
                        <strong>Categoria:</strong><br> {{ tarefa.categoria.nome }}
                    </li>
                    {% endif %}
                    <li class="list-group-item bg-transparent text-white-50 border-bottom-0 border-secondary px-0 px-md-3">
                        <i class="bi bi-person text-success"></i> 
                        <strong>Criador:</strong><br> {{ tarefa.criador.username }}
                    </li>
                </ul>

                <h2 class="h4">Descrição da Tarefa</h2>
                <p class="lead">{{ tarefa.descricao|linebreaks }}</p>

                <hr class="my-4 border-secondary">

                <h2 class="h4">Colaboradores Inscritos ({{ colaboradores_inscritos.count }})</h2>
                {% if colaboradores_inscritos %}
                    <div class="d-flex flex-wrap gap-2">
                        {% for colaborador in colaboradores_inscritos %}
                            <span class="badge rounded-pill bg-success-subtle text-success-emphasis fs-6 fw-normal">
                                <i class="bi bi-person-check-fill"></i> {{ colaborador.username }}
                            </span>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">Ninguém se inscreveu nesta tarefa ainda.</p>
                {% endif %}

                <hr class="my-4 border-secondary">
                
                <div class="text-center">
                    {% if user.is_authenticated %}
                        
                        <div id="botao-container" class="mb-3">
                            {% if inscrito %}
                                {% include 'app/partials/botao_inscrito.html' %}
                            {% else %}
                                <button 
                                    hx-post="{% url 'inscrever_tarefa' tarefa.id %}" 
                                    hx-target="#botao-container" 
                                    hx-swap="innerHTML" 
                                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                    class="btn btn-success btn-lg">
                                    <i class="bi bi-check-circle-fill"></i> Inscrever-se nesta Tarefa
                                </button>
                            {% endif %}
                        </div>

                        {% if inscrito %}
                        <div class="task-completion">
                            {% if tarefa.status == 'concluida' %}
                                <span class="badge rounded-pill bg-primary-subtle text-primary-emphasis fs-5 fw-normal">
                                    <i class="bi bi-check-all"></i> Tarefa Concluída!
                                </span>
                            {% else %}
                                <form method="POST" action="{% url 'concluir_tarefa' tarefa.id %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="bi bi-check-all"></i> Marcar como Concluída
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                        {% endif %}

                    {% else %}
                        <p class="lead"><a href="{% url 'login' %}?next={{ request.path }}">Faça login para se inscrever ou concluir.</a></p>
                    {% endif %}
                </div>

            </div>

            {% if user.is_staff %}
            <div class="card-footer bg-dark-subtle d-flex justify-content-end gap-2">
                <a href="{% url 'atualizarTarefa' tarefa.id %}" class="btn btn-outline-primary">
                    <i class="bi bi-pencil-fill"></i> Editar Tarefa
                </a>
                <a href="{% url 'apagarTarefa' tarefa.id %}" class="btn btn-outline-danger">
                    <i class="bi bi-trash-fill"></i> Apagar Tarefa
                </a>
            </div>
            {% endif %}

        </div>
    </div>
</div>
{% endblock %}

